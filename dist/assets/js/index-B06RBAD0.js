import{r as a,e,w as s,E as l,G as t,s as i,a1 as u,K as n,H as o,Y as c,a2 as v,x as r,F as d,U as g,D as m}from"./vue-vendor-loiPTQO0.js";import{r as p}from"./rquest-BdLykTFq.js";import{_ as f}from"./index-CD_ICcaK.js";import"./ui-vendor-B9LTyEOQ.js";const S={class:"sign-page"},I={class:"container"},y={key:0,class:"card"},b={class:"login-form"},D={class:"form-group"},w={class:"input-row"},h=["disabled"],T={class:"form-group"},k={class:"input-row"},$={key:1,class:"card"},N={class:"profile-content"},M={class:"profile-user"},P=["src"],A={class:"profile-info"},C={class:"profile-name"},E={class:"profile-phone"},x={class:"profile-status-wrapper"},L={class:"profile-status-item"},B={class:"profile-status-value"},j={class:"profile-status-item"},O={class:"profile-status-value"},G={class:"profile-status-item"},Z={class:"profile-status-value"},J={key:2,class:"card"},U={class:"sign-status"},z={class:"status-info"},H={class:"info-item"},V={class:"value"},_={class:"info-item"},Y={class:"value"},W={class:"info-item"},F={class:"action-buttons"},Q=["disabled"],R=["disabled"],q={key:3,class:"card"},K={class:"settings"},X={class:"form-group"},aa={class:"form-group"},ea={class:"checkbox-label"},sa={class:"card"},la={class:"sign-logs"},ta={class:"log-time"},ia={class:"log-message"},ua={key:1,class:"empty-log"},na=f({__name:"index",setup(f){const na=a(!1),oa=a(""),ca=a(""),va=a(""),ra=a(""),da=a(0);let ga=null;const ma=a("未登录"),pa=a(""),fa=a("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjAwIDIwMCI+PGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSIxMDAiIGZpbGw9IiNmZjNhM2EiLz48Y2lyY2xlIGN4PSIxMDAiIGN5PSI4MCIgcj0iNDAiIGZpbGw9IiNmZmYiLz48cGF0aCBkPSJNMTAwIDE0MGMzMCAwIDUwLTIwIDUwLTIwSDUwUzgwIDE0MCAxMDAgMTQweiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg=="),Sa=a(!1),Ia=a(!1),ya=a(0),ba=a(0),Da=a(0),wa=a(""),ha=a(""),Ta=a("未签到"),ka=a("未设置"),$a=a(!1),Na=a("08:00"),Ma=a(!1);let Pa=null;const Aa=a([]);async function Ca(){if(!oa.value||!/^1\d{10}$/.test(oa.value))return va.value="请输入有效的手机号!",void(ra.value="error");va.value="正在获取验证码...",ra.value="",da.value=60,ga=setInterval(()=>{da.value>0?da.value--:clearInterval(ga)},1e3);try{const a=await p.get(`/users/auth-code/${oa.value}`);a.success?(va.value="验证码已发送，请查收!",ra.value="success",Za(`验证码已发送至 ${oa.value}`)):(va.value="获取验证码失败: "+(a.message||"未知错误"),ra.value="error",Za(`获取验证码失败: ${a.message||"未知错误"}`),clearInterval(ga),da.value=0)}catch(a){va.value="网络错误，请重试!",ra.value="error",Za(`网络错误: ${a.message}`),clearInterval(ga),da.value=0}}async function Ea(){if(!oa.value||!/^1\d{10}$/.test(oa.value))return va.value="请输入有效的手机号!",void(ra.value="error");if(!ca.value)return va.value="请输入验证码!",void(ra.value="error");va.value="正在登录...",ra.value="";try{const a=await p.post("/users/login",{phone:oa.value,authCode:ca.value});a.success?(na.value=!0,a.user&&(ma.value=a.user.nickName||"用户"+oa.value.substring(7),pa.value=oa.value,a.user.avatar&&(fa.value=a.user.avatar),void 0!==a.user.pointsBalance&&(Da.value=a.user.pointsBalance),void 0!==a.user.autoSignEnabled&&($a.value=a.user.autoSignEnabled),a.user.signTime&&(Na.value=a.user.signTime)),localStorage.setItem("userPhone",oa.value),localStorage.setItem("userName",ma.value),localStorage.setItem("userToken",a.user.token||""),Ja(),Oa(),Za(`用户登录成功: ${oa.value}`),va.value="",$a.value&&Ga()):(va.value="登录失败: "+(a.message||"未知错误"),ra.value="error",Za(`登录失败: ${a.message||"未知错误"}`))}catch(a){va.value="网络错误，请重试!",ra.value="error",Za(`登录失败，网络错误: ${a.message}`)}}async function xa(){if(!Sa.value&&!Ia.value){Ia.value=!0,wa.value="正在签到...",ha.value="";try{const a=localStorage.getItem("userPhone");if(!a)throw new Error("未找到用户信息，请重新登录");const e=await p.post(`/sign/${a}`);if(e.success){if(Sa.value=!0,void 0!==e.data.pointsBalance&&(Da.value=e.data.pointsBalance),void 0!==e.data.continuousDays&&(ya.value=e.data.continuousDays),void 0!==e.data.totalSignDays&&(ba.value=e.data.totalSignDays),e.data.lastSignIn){const a=new Date(e.data.lastSignIn);Ta.value=a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),localStorage.setItem("lastSignIn",e.data.lastSignIn)}let a=0;e.data.bonusPoints&&(a=e.data.bonusPoints),wa.value=a>0?`签到成功！获得5积分 + ${a}连续签到奖励`:"签到成功！获得5积分",ha.value="success",Za(`签到成功，获得5${a>0?" + "+a:""}积分`),function(){const a={todaySigned:Sa.value,lastSignTime:Ta.value,continuousDays:ya.value,totalSignDays:ba.value,totalPoints:Da.value,lastSignDate:(new Date).toISOString().split("T")[0]};localStorage.setItem("signData",JSON.stringify(a))}(),$a.value&&Ga(),Oa()}else wa.value="签到失败: "+(e.message||"未知错误"),ha.value="error",Za(`签到失败: ${e.message||"未知错误"}`),(401===e.code||e.message&&(e.message.includes("Token")||e.message.includes("token")))&&(na.value=!1,localStorage.removeItem("userToken"),Za("Token已过期，请重新登录"))}catch(a){wa.value="签到失败，请稍后重试",ha.value="error",Za(`签到失败，网络错误: ${a.message}`)}finally{Ia.value=!1}}}async function La(){const a=!$a.value,e=localStorage.getItem("userPhone");if(!e)return wa.value="请先登录!",void(ha.value="error");try{const s=await p.put(`/users/${e}`,{autoSignEnabled:a});s.success?($a.value=a,$a.value?(wa.value="自动签到已开启",ha.value="success",Za("自动签到已开启"),Ga()):(wa.value="自动签到已关闭",ha.value="success",Za("自动签到已关闭"),Pa&&(clearTimeout(Pa),Pa=null)),Ba()):(wa.value="更新自动签到设置失败",ha.value="error",Za(`更新自动签到设置失败: ${s.message||"未知错误"}`))}catch(s){wa.value="网络错误，请重试",ha.value="error",Za(`网络错误: ${s.message}`)}}async function Ba(){const a=localStorage.getItem("userPhone");if(a)try{const e=await p.put(`/users/${a}`,{signTime:Na.value,notificationsEnabled:Ma.value});if(e.success){const a={autoSignEnabled:$a.value,signTime:Na.value,notificationsEnabled:Ma.value};localStorage.setItem("signSettings",JSON.stringify(a)),$a.value&&Ga()}else Za(`保存设置失败: ${e.message||"未知错误"}`)}catch(e){Za(`保存设置失败，网络错误: ${e.message}`)}}async function ja(){try{const a=await p.delete("/sign/logs");a.success?(Aa.value=[],localStorage.setItem("signLogs",JSON.stringify(Aa.value)),Za("日志已清空")):Za(`清空日志失败: ${a.message||"未知错误"}`)}catch(a){Za(`清空日志失败，网络错误: ${a.message}`)}}async function Oa(){try{const a=(await p.get("/sign/logs?limit=50")).data||[];if(!a||!Array.isArray(a))return;Aa.value=a.map(a=>({time:new Date(a.time).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),message:`${a.nickName||a.phone||""}: ${a.message}`})),localStorage.setItem("signLogs",JSON.stringify(Aa.value))}catch(a){Za(`获取日志失败: ${a.message}`)}}function Ga(){Pa&&clearTimeout(Pa);const a=new Date,[e,s]=Na.value.split(":").map(Number),l=new Date;l.setHours(e,s,0,0),a>l&&l.setDate(l.getDate()+1),ka.value=l.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});const t=l-a;Za(`下次签到安排在 ${l.toLocaleString()}`),Pa=setTimeout(()=>{Sa.value?(Za("今天已经签到过，跳过自动签到"),Ga()):xa()},t)}function Za(a){const e=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});Aa.value.unshift({time:e,message:a}),Aa.value.length>10&&(Aa.value=Aa.value.slice(0,10)),localStorage.setItem("signLogs",JSON.stringify(Aa.value))}function Ja(){try{const a=JSON.parse(localStorage.getItem("signData"));if(a){const e=(new Date).toISOString().split("T")[0];if(Sa.value=a.todaySigned&&a.lastSignDate===e,Ta.value=a.lastSignTime||"未签到",ya.value=a.continuousDays||0,ba.value=a.totalSignDays||0,Da.value=a.totalPoints||0,a.lastSignDate!==e){Sa.value=!1;const e=new Date(a.lastSignDate),s=new Date;s.setDate(s.getDate()-1),e.toISOString().split("T")[0]!==s.toISOString().split("T")[0]&&(ya.value=0,Za("连续签到中断了，重新开始计数"))}}}catch(a){}}async function Ua(){try{const a=JSON.parse(localStorage.getItem("signLogs"));a&&Array.isArray(a)&&(Aa.value=a),await Oa()}catch(a){}}return e(async()=>{await async function(){const a=localStorage.getItem("userPhone"),e=localStorage.getItem("userToken");if(a&&e)try{const e=await p.get(`/users/${a}`);return e.success&&e.data?(na.value=!0,pa.value=a,ma.value=e.data.nickName||localStorage.getItem("userName")||"用户"+a.substring(7),e.data.avatar&&(fa.value=e.data.avatar),void 0!==e.data.pointsBalance&&(Da.value=e.data.pointsBalance),void 0!==e.data.continuousDays&&(ya.value=e.data.continuousDays),void 0!==e.data.totalSignDays&&(ba.value=e.data.totalSignDays),void 0!==e.data.autoSignEnabled&&($a.value=e.data.autoSignEnabled),e.data.signTime&&(Na.value=e.data.signTime),!0):(localStorage.removeItem("userToken"),!1)}catch(s){return!1}return!1}()?(!function(){try{const a=JSON.parse(localStorage.getItem("signSettings"));a&&($a.value=a.autoSignEnabled||!1,Na.value=a.signTime||"08:00",Ma.value=a.notificationsEnabled||!1)}catch(a){}}(),Ja(),Ua(),$a.value&&Ga()):Ua(),setTimeout(()=>{alert("该功能仅供娱乐")},300)}),s(Na,()=>{$a.value&&Ga()}),(a,e)=>(m(),l("div",S,[t("div",I,[na.value?c("",!0):(m(),l("div",y,[e[6]||(e[6]=t("div",{class:"card-title"},"登录",-1)),t("div",b,[t("div",D,[e[4]||(e[4]=t("label",{for:"phoneInput"},"手机号码",-1)),t("div",w,[i(t("input",{type:"text",id:"phoneInput",class:"input-field",placeholder:"请输入手机号","onUpdate:modelValue":e[0]||(e[0]=a=>oa.value=a)},null,512),[[u,oa.value]]),t("button",{class:"addon-btn",id:"getCode",onClick:Ca,disabled:da.value>0},n(da.value>0?`重新获取(${da.value})`:"获取验证码"),9,h)])]),t("div",T,[e[5]||(e[5]=t("label",{for:"codeInput"},"验证码",-1)),t("div",k,[i(t("input",{type:"text",id:"codeInput",class:"input-field",placeholder:"请输入验证码","onUpdate:modelValue":e[1]||(e[1]=a=>ca.value=a)},null,512),[[u,ca.value]])])]),t("div",{class:"login-actions"},[t("button",{class:"btn",id:"loginBtn",onClick:Ea},"登录")]),va.value?(m(),l("div",{key:0,class:o(["status",ra.value])},n(va.value),3)):c("",!0)])])),na.value?(m(),l("div",$,[e[10]||(e[10]=t("div",{class:"card-title"},"用户信息",-1)),t("div",N,[t("div",M,[t("img",{src:fa.value,class:"profile-avatar",alt:"用户头像"},null,8,P),t("div",A,[t("div",C,n(ma.value),1),t("div",E,n(pa.value),1)])]),t("div",x,[t("div",L,[t("div",B,n(ya.value),1),e[7]||(e[7]=t("div",{class:"profile-status-label"},"连续签到(天)",-1))]),t("div",j,[t("div",O,n(Da.value),1),e[8]||(e[8]=t("div",{class:"profile-status-label"},"当前积分",-1))]),t("div",G,[t("div",Z,n(ba.value),1),e[9]||(e[9]=t("div",{class:"profile-status-label"},"总签到(天)",-1))])])])])):c("",!0),na.value?(m(),l("div",J,[e[14]||(e[14]=t("div",{class:"card-title"},"签到状态",-1)),t("div",U,[t("div",z,[t("div",H,[e[11]||(e[11]=t("span",{class:"label"},"上次签到：",-1)),t("span",V,n(Ta.value),1)]),t("div",_,[e[12]||(e[12]=t("span",{class:"label"},"下次签到：",-1)),t("span",Y,n(ka.value),1)]),t("div",W,[e[13]||(e[13]=t("span",{class:"label"},"今日状态：",-1)),t("span",{class:o(["value",{signed:Sa.value}])},n(Sa.value?"已签到":"未签到"),3)])]),t("div",F,[t("button",{class:"btn",disabled:Sa.value||Ia.value,onClick:xa},n(Ia.value?"签到中...":Sa.value?"今日已签到":"立即签到"),9,Q),t("button",{class:o(["btn",$a.value?"btn-secondary":""]),disabled:Ia.value,onClick:La},n($a.value?"关闭自动签到":"开启自动签到"),11,R)]),wa.value?(m(),l("div",{key:0,class:o(["status",ha.value])},n(wa.value),3)):c("",!0)])])):c("",!0),na.value&&$a.value?(m(),l("div",q,[e[17]||(e[17]=t("div",{class:"card-title"},"自动签到设置",-1)),t("div",K,[t("div",X,[e[15]||(e[15]=t("label",{for:"signTime"},"签到时间",-1)),i(t("input",{type:"time",id:"signTime","onUpdate:modelValue":e[2]||(e[2]=a=>Na.value=a),onChange:Ba},null,544),[[u,Na.value]])]),t("div",aa,[t("label",ea,[i(t("input",{type:"checkbox",id:"enableNotification","onUpdate:modelValue":e[3]||(e[3]=a=>Ma.value=a),onChange:Ba},null,544),[[v,Ma.value]]),e[16]||(e[16]=r(" 启用签到提醒通知 "))])])])])):c("",!0),t("div",sa,[e[19]||(e[19]=t("div",{class:"card-title"},"签到日志",-1)),t("div",la,[Aa.value.length>0?(m(!0),l(d,{key:0},g(Aa.value,(a,e)=>(m(),l("div",{class:"log-item",key:e},[t("span",ta,n(a.time),1),t("span",ia,n(a.message),1)]))),128)):(m(),l("div",ua," 暂无签到日志 "))]),t("div",{class:"log-footer"},[e[18]||(e[18]=t("span",null,"日志显示最近记录",-1)),t("button",{class:"btn btn-small",onClick:ja},"清空日志")])])])]))}},[["__scopeId","data-v-388f7913"]]);export{na as default};
